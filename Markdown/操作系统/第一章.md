# 操作系统概述

- [操作系统概述](#%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f%e6%a6%82%e8%bf%b0)
  - [操作系统概念](#%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f%e6%a6%82%e5%bf%b5)
    - [操作系统定义](#%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f%e5%ae%9a%e4%b9%89)
    - [操作系统作用](#%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f%e4%bd%9c%e7%94%a8)
    - [操作系统地位](#%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f%e5%9c%b0%e4%bd%8d)
  - [操作系统的历史](#%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f%e7%9a%84%e5%8e%86%e5%8f%b2)
    - [操作系统的产生](#%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f%e7%9a%84%e4%ba%a7%e7%94%9f)
      - [**手工操作阶段**(20世纪40年代)](#%e6%89%8b%e5%b7%a5%e6%93%8d%e4%bd%9c%e9%98%b6%e6%ae%b520%e4%b8%96%e7%ba%aa40%e5%b9%b4%e4%bb%a3)
      - [**批处理阶段**（20世纪50年代）](#%e6%89%b9%e5%a4%84%e7%90%86%e9%98%b6%e6%ae%b520%e4%b8%96%e7%ba%aa50%e5%b9%b4%e4%bb%a3)
        - [**联机批处理**(I/O设备与主机相连)](#%e8%81%94%e6%9c%ba%e6%89%b9%e5%a4%84%e7%90%86io%e8%ae%be%e5%a4%87%e4%b8%8e%e4%b8%bb%e6%9c%ba%e7%9b%b8%e8%bf%9e)
        - [**脱机批处理**(I/O设备与卫星机相连)](#%e8%84%b1%e6%9c%ba%e6%89%b9%e5%a4%84%e7%90%86io%e8%ae%be%e5%a4%87%e4%b8%8e%e5%8d%ab%e6%98%9f%e6%9c%ba%e7%9b%b8%e8%bf%9e)
      - [**执行系统阶段**（Executive System 60年代初）](#%e6%89%a7%e8%a1%8c%e7%b3%bb%e7%bb%9f%e9%98%b6%e6%ae%b5executive-system-60%e5%b9%b4%e4%bb%a3%e5%88%9d)
    - [操作系统的完善](#%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f%e7%9a%84%e5%ae%8c%e5%96%84)
      - [**多道批处理系统**( Multi-programming System 60年代初)](#%e5%a4%9a%e9%81%93%e6%89%b9%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f-multi-programming-system-60%e5%b9%b4%e4%bb%a3%e5%88%9d)
      - [**分时系统** (Time-Sharing System 60年代初/中期)](#%e5%88%86%e6%97%b6%e7%b3%bb%e7%bb%9f-time-sharing-system-60%e5%b9%b4%e4%bb%a3%e5%88%9d%e4%b8%ad%e6%9c%9f)
      - [**实时系统**(Real-Time System 60年代中期)](#%e5%ae%9e%e6%97%b6%e7%b3%bb%e7%bb%9freal-time-system-60%e5%b9%b4%e4%bb%a3%e4%b8%ad%e6%9c%9f)
      - [**通用操作系统**  (60年代后期)](#%e9%80%9a%e7%94%a8%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f-60%e5%b9%b4%e4%bb%a3%e5%90%8e%e6%9c%9f)
    - [操作系统的发展](#%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f%e7%9a%84%e5%8f%91%e5%b1%95)
  - [操作系统的特性](#%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f%e7%9a%84%e7%89%b9%e6%80%a7)
    - [程序并发性](#%e7%a8%8b%e5%ba%8f%e5%b9%b6%e5%8f%91%e6%80%a7)
    - [资源共享性](#%e8%b5%84%e6%ba%90%e5%85%b1%e4%ba%ab%e6%80%a7)
    - [虚拟](#%e8%99%9a%e6%8b%9f)
    - [异步](#%e5%bc%82%e6%ad%a5)
  - [操作系统的分类(上课跳过了)](#%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f%e7%9a%84%e5%88%86%e7%b1%bb%e4%b8%8a%e8%af%be%e8%b7%b3%e8%bf%87%e4%ba%86)
    - [多道批处理系统（以脱机操作为标志）](#%e5%a4%9a%e9%81%93%e6%89%b9%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f%e4%bb%a5%e8%84%b1%e6%9c%ba%e6%93%8d%e4%bd%9c%e4%b8%ba%e6%a0%87%e5%bf%97)
    - [分时操作系统](#%e5%88%86%e6%97%b6%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f)
  - [操作系统的硬件环境](#%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f%e7%9a%84%e7%a1%ac%e4%bb%b6%e7%8e%af%e5%a2%83)
    - [定时装置](#%e5%ae%9a%e6%97%b6%e8%a3%85%e7%bd%ae)
      - [绝对时钟[^3]](#%e7%bb%9d%e5%af%b9%e6%97%b6%e9%92%9f3)
      - [间隔时钟](#%e9%97%b4%e9%9a%94%e6%97%b6%e9%92%9f)
    - [系统栈[^4]](#%e7%b3%bb%e7%bb%9f%e6%a0%884)
    - [处理机状态及状态转换](#%e5%a4%84%e7%90%86%e6%9c%ba%e7%8a%b6%e6%80%81%e5%8f%8a%e7%8a%b6%e6%80%81%e8%bd%ac%e6%8d%a2)
      - [管态](#%e7%ae%a1%e6%80%81)
      - [目态](#%e7%9b%ae%e6%80%81)
      - [状态转换](#%e7%8a%b6%e6%80%81%e8%bd%ac%e6%8d%a2)
    - [特权指令与非特权指令](#%e7%89%b9%e6%9d%83%e6%8c%87%e4%bb%a4%e4%b8%8e%e9%9d%9e%e7%89%b9%e6%9d%83%e6%8c%87%e4%bb%a4)
    - [地址映射机构[^6]](#%e5%9c%b0%e5%9d%80%e6%98%a0%e5%b0%84%e6%9c%ba%e6%9e%846)
    - [存储保护设施](#%e5%ad%98%e5%82%a8%e4%bf%9d%e6%8a%a4%e8%ae%be%e6%96%bd)
    - [中断装置](#%e4%b8%ad%e6%96%ad%e8%a3%85%e7%bd%ae)
    - [通道与DMA控制器](#%e9%80%9a%e9%81%93%e4%b8%8edma%e6%8e%a7%e5%88%b6%e5%99%a8)
      - [通道](#%e9%80%9a%e9%81%93)
      - [DMA (Direct Memory Access, 直接内存访问)](#dma-direct-memory-access-%e7%9b%b4%e6%8e%a5%e5%86%85%e5%ad%98%e8%ae%bf%e9%97%ae)
  - [操作系统界面形式](#%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f%e7%95%8c%e9%9d%a2%e5%bd%a2%e5%bc%8f)
    - [交互终端命令（Command Line）](#%e4%ba%a4%e4%ba%92%e7%bb%88%e7%ab%af%e5%91%bd%e4%bb%a4command-line)
    - [**图形用户界面**（GUI—Graphic User Interface）](#%e5%9b%be%e5%bd%a2%e7%94%a8%e6%88%b7%e7%95%8c%e9%9d%a2guigraphic-user-interface)
    - [**作业控制语言**（Job Control Language, JCL）](#%e4%bd%9c%e4%b8%9a%e6%8e%a7%e5%88%b6%e8%af%ad%e8%a8%80job-control-language-jcl)
    - [**系统调用命令**(System Call)](#%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8%e5%91%bd%e4%bb%a4system-call)
  - [**操作系统的运行机理**](#%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f%e7%9a%84%e8%bf%90%e8%a1%8c%e6%9c%ba%e7%90%86)

---

## 操作系统概念

### 操作系统定义

- 位于硬件层(HAL)之上、所有其它软件层之下的一个`系统软件`，是管理和控制计算机系统中的`硬件`以及`软件`资源、方便用户使用计算机系统的`程序集合`，能合理组织计算机工作流程，使用户能高效地利用计算机，在用户和计算机之间起到`接口`的作用。

### 操作系统作用

- 管理系统中的软硬件资源
  
  > 从资源管理的观点，OS是计算机系统资源[^1]的管理者，它负责管理和分配系统中的各种硬件和软件资源，以保证系统的各种资源得以有效利用。
  > >OS提供的管理:  
  > >
  > >- 处理机管理（进程管理）:用于分配和控制处理机。 
  > >- 存储器管理：主要负责内存的分配和回收  
  > >- I/O设备管理：负责I/O设备的分配和操纵  
  > >- 文件管理：负责文件的存取、共享和保护

- 为用户提供良好的界面
  
  > 命令方式、API、GUI[^2]

### 操作系统地位

- 硬件抽象层（HAL）之上，所有其它软件层之下

  ![https://raw.githubusercontent.com/FANSENG/Figure-bed/master/Picture/%E5%9C%B0%E4%BD%8D.png](https://raw.githubusercontent.com/FANSENG/Figure-bed/master/Picture/操作系统/地位.png)
  上图所示的层次关系具有穿透性：<u>高层软件可调用所有低于所在层次的软件,并可与硬件直接打交道</u>
  ![https://raw.githubusercontent.com/FANSENG/Figure-bed/master/Picture/%E8%B0%83%E7%94%A8%E5%9B%BE.png](https://raw.githubusercontent.com/FANSENG/Figure-bed/master/Picture/操作系统/调用图.png)

- 操作系统是配置在计算机<u>硬件上的第一层软件</u>，是对硬件系统的第一次扩充。 OS在计算机系统中占据着特殊重要的地位，其它<u>所有软件==都依赖于它==</u>的支持，它是与硬件关系<u>最密切</u>的系统软件

---

## 操作系统的历史

- **传统操作系统的三大类别:**

    >多道批处理操作系统、分时操作系统、实时操作系统。 一个实际的操作系统可能兼具三者或其中两者的功能。

    

### 操作系统的产生

#### **手工操作阶段**(20世纪40年代)

> 无操作系统，人在计算机中工作

- 作业处理步骤:
> 1.将程序和数据通过手工操作记录在穿孔纸带上
> 2.将程序纸带放到光电输入机上，再通过控制台开关启
> 3.动光电机将程序输入内存
> 4.通过控制台开关启动程序由第一条指令开始执行
> 5.运行结果在电传打印机上输出。

![](https://raw.githubusercontent.com/FANSENG/Figure-bed/master/Picture/操作系统/手工作业流程图.png)

- 手工操作缺点:
> 1.用户在其作业处理的整个过程中**独享系统的全部资源**
> 2.手工操作所需**时间很长**(人机矛盾)

#### **批处理阶段**（20世纪50年代）

> 缩短手工操作时间，使作业到作业之间的过渡摆脱人的干预, 实现自动化,提高了效率。是==**操作系统的雏形**==。

##### **联机批处理**(I/O设备与主机相连)

- 工作原理:
  > <u>操作员</u>将<u>若干作业合成一批</u>,将其卡片依次放到<u>读卡机</u>上,监督程序<u>Monitor</u>通过内存将这批作业传送到磁带机上大量作业<u>在磁带机上排队等待处理</u>。<u>输入完毕,监督程序开始处理这一批作业。</u>它自动将第一个作业读入内存,并对其进行汇编(或编译)、连接、执行、输出。第一个作业处理完立即开始处理第二个作业,如此重复,直至所有作业处理完,再处理第二批作业。

  ![https://raw.githubusercontent.com/FANSENG/Figure-bed/master/Picture/%E8%81%94%E6%9C%BA%E6%89%B9%E5%A4%84%E7%90%86.png](https://raw.githubusercontent.com/FANSENG/Figure-bed/master/Picture/操作系统/联机批处理.png)

- 优点:
  > 作业自动转换，大大缩短了手工操作时间
  > 出现了Monitor及相应软件的支持

- 缺点:
  
  > 设备的传输速度远低于处理机的速度,I/O设备与CPU直接相连，CPU(主机)浪费(处理机利用monitor程序来处理I/O)
- 改进思想:
  
  > 把输入/输出操作交给一个功能较为单纯的卫星机去做，使主机从繁琐的输入输出操作中解脱出来

##### **脱机批处理**(I/O设备与卫星机相连)

  > 待处理的作业由卫星机负责经读卡机传送到输入磁带上，主机从输入磁带读入作业、加以处理，并把处理结果送到输出磁带上，最后由卫星机负责将输出磁带上的结果在打印机上输出

  ![https://raw.githubusercontent.com/FANSENG/Figure-bed/master/Picture/%E8%84%B1%E6%9C%BA%E6%89%B9%E5%A4%84%E7%90%86.png](https://raw.githubusercontent.com/FANSENG/Figure-bed/master/Picture/操作系统/脱机批处理.png)

  优点：
  > 卫星机与主机<u>分工明确</u>，**并行**工作，提高了CPU的利用率。

  缺点:
  > 单任务系统；人工拆装磁带。

#### **执行系统阶段**（Executive System 60年代初）

> 硬件的重要进展：**通道**、**中断技术**
> Monitor常驻内存，是OS的==**初级阶段**==

- 通道(channel):
  
> 也称**I/O处理机**，它<u>具有自己的指令系统和运控部件</u>，可接受处理机的委托执行通道程序，完成I/O操作。通道的I/O操作可与处理机的计算工作**完全并行**，并在<u>**I/O操作完成时向处理机发出中断请求**</u>。

- 中断(Interrupt):
  
> 中断是指当<u>主机接到某种外部信号</u>(如I/O设备完成信号)时，马上<u>暂停原来的工作，转去处理这一事件，处理完毕再回到原来的断点继续工作</u>。

![](https://raw.githubusercontent.com/FANSENG/Figure-bed/master/Picture/操作系统/执行系统阶段.png)

- 假脱机(Spooling):
  
> 作业由<u>读卡机到存储区的传输</u>以及<u>运行结果由存储区到打印机的传输</u>由**通道完成**，这种方式既**非联机**，也**非脱机**（也不是依靠卫星机），称为“**假脱机**”或“**伪脱机**”。

- 优点:
  
  > 通道取代卫星机，免去了手工装卸磁带的麻烦。

### 操作系统的完善

> 多道批处理系统和分时系统的出现标志OS已进入==**完善阶段**==

#### **多道批处理系统**( Multi-programming System 60年代初)

> 无交互能力

- 工作流程
  
> 用户提交的作业都先放在<u>外存</u>上并排成一个<u>后备队列</u>，然后由<u>作业调度程序</u>按一定的算法从后备队列中<u>选择若干个作业调入内存</u>。当<u>一道作业因等待I/O传输完成等原因暂时不能运行时，系统可将CPU资源分配给另一个可运行的作业</u>。
>
> - 只有一个作业占据CPU，其他作业等待获得CPU资源。

- 基本原理
  
> 同时把若干道程序放入内存，并使它们交替的执行。内存中同时存放几道相互独立的程序。	

- 特点
  > 1.==多道==:内存中同时存放几道相互独立的程序
  > 2.==宏观并行==:多个作业调入内存，同时占有资源各自运行，但都未完成
  > 3.==微观串行==:轮流占有处理机，交替执行

- 单道和多道比较
  > 在<u>单道批处理</u>中，当作业完成，而下一个作业还没被调入内存时，==CPU空闲==。
  > 在<u>多道批处理</u>，充分利用了CPU。本质上是同时把若干道程序放入内存，并使它们交替的执行。这样==始终使CPU处于忙状态==，要比单道批处理复杂的多。

- 优点
  
>  资源利用率高；系统吞叶量(单位时间完成作业量)大

- 缺点
  
  > 作业的平均周转时间长；无交互能力

#### **分时系统** (Time-Sharing System 60年代初/中期)

> **有交互能力**	

>  指在**一台主机**上连接了**多个**带有显示器和键盘的**终端**，同时允许多个用户共享主机中的资源，每个用户都可通过自己的终端以==**交互方式**==使用计算机。分时系统==便于程序的动态修改和调试==。

- 分时系统的特点

    > 1.**多路性**：一个主机与多个终端相连，系统按分时原则为每个用户服务。<u>**宏观上**，多个用户同时工作,==共享系统资源==；**微观上**，每个用户==轮流运行一个时间片==</u>。
    >
    > 2.**交互性**：以对话的方式为用户服务。
    >
    > 3.**独占性**：每个终端用户仿佛拥有一台虚拟机。

#### **实时系统**(Real-Time System 60年代中期)

> 指系统能<u>即时响应外部事件的请求</u>，在<u>规定时间内完成</u>对事件的处理，并<u>控制所有实时任务协调一致</u>地运行。它分为**实时信息处理系统**和**实时控制系统**两大类。

- **实时信息处理系统**由一台或多台主机通过**通信线路**连接成百上千个远程终端，计算机接收从远程终端发来的服务请求，根据用户提出的问题，对信息进行检索和处理，并**在很短时间内**为用户做出正确的**回答**。如飞机订票系统。

#### **通用操作系统**  (60年代后期)

> 将多道批处理、分时和实时等功能结合在一起构造出的多功能的操作系统，称为**通用操作系统**。

### 操作系统的发展

近30年来, OS取得了很大发展，主要表现在： 

>1.硬件体系结构由集中向分散发展，出现计算机网络，为此**网络操作系统**和**分布式操作系统**应运而生。
>
>2.微处理机的发展使家庭和商用的微型机得到了普及。为方便非计算机专业人员使用，OS提供了**友好的操作界面**。
>
>3.在科学和军事领域，大型计算任务要求极强的计算处理能力，多处理机并行成为必然，由此产生**并行操作系统**。
>
>4.随着处理机芯片和各种存储介质在各种控制领域的广泛应用，**嵌入式**和**智能卡操作系统**应运而生。为降低开发代价，尝试从不同应用中抽取具有共性的东西，并做成很小的操作系统核心，由此产生了**微内核操作系统体系结构**。

## 操作系统的特性

### 程序并发性

> - **程序并发**指计算机系统中同时存在多个程序，宏观上，这些程序同时向前推进。
>
> - > **并发**：指在计算机系统中同时存在着多道运行的程序（进程）。
>     >
>     > 宏观上：多道程序同时在执行
>     >
>     > 微观上：任何时刻只有一道程序在执行，即微观上多道程序在CPU上轮流执行（单个硬件，通过微观上快速的交替执行程序实现宏观并发）
>
> - **并行**(parallel)： 与并发相似，指多道程序在同一时刻执行，但**需==多个硬件==支持**。
> - **程序并行**要求微观上的同时,即在绝对同一时刻有多个程序同时向前推进；
> - **程序并发**并不要求微观上的同时,只需要在宏观上看来多个程序都在向前推进。
> - 在**单处理机操作系统**中，通常使用**并发**这个术语，尽管处理机与设备之间、设备与设备之间可以并行工作。
> - **并发**是操作系统==最重要的特征==，其他特征都是以并发为**前提**。

### 资源共享性

> > - **资源共享**是指操作系统<u>程序与多个用户程序</u>共用系统中的各种资源，这种<u>共享是在操作系统的控制下实现的</u>。
> > - 资源包括：「**中央处理器**」，「**内外存储器**」，「**外部设备等**」。
> > - 共享有两种形式：『**互斥共享**』和『**同时共享**』。
>
> - **互斥共享：**系统中有一些资源，当<u>一个进程正在访问该资源时，其他进程必须等待</u>，直到该进程访问完并释放这些资源时，其他进程才能访问这些资源。这就是互斥共享，互斥共享的资源叫「**临界资源**」。如：打印机等物理设备或者表格就是临界资源，它们要求互斥共享。
>
> - **同时共享：**系统中有一类资源，<u>允许在一段时间内，由多个进程同时对其访问</u>。这就是同时共享，本质还是『宏观上时同时，微观上是交替分时』的。如，磁盘，同时可以多个进程访问磁盘。
> - 「**并发**」和「**共享**」是OS的两个**最基本特征**，它们**互为存在条件**。这是因为只有进程的并发执行，才可能要求资源共享。也只有资源能够合理的实现共享，进程才能并发执行。

### 虚拟

> - 「**虚拟**」的本质含义是把物理上的一个变成逻辑上的多个。也就是把<u>一个物理实体映射为若干个对应的逻辑实体</u>——「**分时**」或「**分空间**」。
> - 如：「**多道分时技术**」能把<u>一台物理CPU虚拟为多台逻辑上的CPU</u>。还有「**虚拟存储器技术**」和「**虚拟设备技术**」。

### 异步

> - 指操作系统控制下的多个作业的**运行顺序**和每个作业的**运行时间**是**不确定**的，也就是进程在执行中，其<u>执行时间、顺序、向前推进的速度和完成的时间等都是不可预知</u>的。因此先进入内存的作业可能比后进入的作业后完成。
> - 「**并发进程中资源限制**」等原因。例如，在单处理机环境下，由于系统中只有一个处理机，因此每次只允许一个进程占有其执行，其余进程只能等待，造成异步，这样<u>先得到处理机或其他资源的进程先完成</u>。

## 操作系统的分类(上课跳过了)

### 多道批处理系统（以脱机操作为标志）

> - 工作原理：
>
> ![https://raw.githubusercontent.com/FANSENG/Figure-bed/master/Picture/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%A4%9A%E9%81%93%E6%89%B9%E5%A4%84%E7%90%86%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86.png](https://raw.githubusercontent.com/FANSENG/Figure-bed/master/Picture/操作系统/多道批处理工作原理.png)
>
> - 作业：用户程序+数据+作业说明书**(JCL编写，作业控制语言)**
>
> - **输入井**：用于保存已经输入、尚未处理的作业。外存
>
> - **输出井**：用于保存处理完毕、尚未输出的结果。外存
>
> - **结果**：程序运行结果+记帐信息。
>
> - **Spooling** 假脱机技术：虚拟设备技术。就是用一道程序来**模拟外围设备控制机**。
>
> - 批作业的处理步骤
>
>     > - 用户将作业交给机房;
>     > - 操作员在适当的时刻将作业放到某台输入机上并启动其工作, 通道负责将作业传输到输入井中； 
>     > - 执行某种作业调度算法把作业从输入井读入内存，此时作业以“进程”为单位在内存中运行, 运行结束后, 其结果被写入输出井中；
>     > - 最后再由通道负责将结果在输出机上输出。
>
> - 设置输入井和输出井的目的:
>
>     > - 协调I/O设备速度与处理机速度之间的差异; 
>     > - 为作业调度提供条件。如果没有输入井, 系统只能按照自然次序处理作业, 设置输入井后, 系统可以根据调度需要在输入井中选择进入内存的作业, 使得内存中运行的作业搭配合理。 
>
> - 主机中作业合理搭配的目标：
>
>     > 目标1：提高资源利用率(eg. 计算型+I/O型)
>     >
>     > 目标2：提高系统吞吐量(throughput)
>
> - 多道批处理系统的特点：
>
>     > - 多道：内存中同时存在多个正在处理的作业。
>     > - 成批：作业分批进入系统，作业与作业之间的过渡由操作系统控制，无需用户干预。

### 分时操作系统

> - 工作原理
>
> ![https://raw.githubusercontent.com/FANSENG/Figure-bed/master/Picture/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%88%86%E6%97%B6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86.png](https://raw.githubusercontent.com/FANSENG/Figure-bed/master/Picture/操作系统/分时操作系统工作原理.png)
>
> > 一个主机同多个交互终端相连。
> >
> > 它将时间划分为若干个片段, 称作**时间片**, 并以时间片为基本单位**轮流**地为各个交互终端用户服务。由于时间片通常很小, 如十几毫秒或几十毫秒, 系统为所有用户服务一次仅需较少的时间。例如对于一个拥有50个终端的系统来说, 假设时间片长度为40毫秒, 一个终端每隔两秒钟左右便能得到一次系统响应。
>
> - 三个重要特性：
>
>     > - 多路性：一个主机与多个终端相连。
>     > - 交互性：系统以对话的方式为用户服务。
>     > - 独占性：每个终端用户仿佛独占整个计算机系统，即拥有一台完全属于自己的虚拟机。

## 操作系统的硬件环境

### 定时装置

#### 绝对时钟[^3]

- 记载实际时间，不中断。

#### 间隔时钟

> - 也称**闹钟**，它每隔固定时间，发生一次时钟中断。<u>时钟中断发生后，OS获得系统的控制权，以便运行系统管理和**实现程序并发**</u>。
> - 除时钟外还有其它事件可引起中断，但那些事件是否发生、何时发生不确定，只有**时钟中断**最忠实可靠。间隔时钟是现代操作系统(多道程序设计)的**==基础==**。

### 系统栈[^4]

> - **系统栈**是**内存**中**操作系统空间**的一个固定区域。
>
> - 主要用途：
>
>     > 1.中断响应时**保存中断现场**。对于嵌套中断，被中断程序的现场信息依次压入系统栈，中断返回时逆序弹出；
>     >
>     > 2.保存操作系统<u>子程序间相互调用的参数、返回值、返回点以及子程序的局部变量</u>。

### 处理机状态及状态转换

#### 管态

> 也称**系统态**、**核心态**，<u>**是操作系统运行时所处的状态**</u>。机器处于**管态**时可以执行硬件提供的**全部指令**，包括特权指令和非特权指令。

#### 目态

> 也称**用户态**，**是一般用户程序运行时所处的状态。**处理机处于**目态**时只能执行非特权指令。

#### 状态转换

- **管态=>目态**

    > 管态到目态的转换由**修改程序状态字**来实现。
    >
    > 利用特权指令可以修改`PSW`，而`机器状态位`是`PSW`的一部分，因而在管态下可以通过修改`PSW`来改变机器状态，使之由管态转换为目态。

- **目态=>管态**

    > 处理机状态由目态转为管态的「唯一途径」是**中断**。中断发生时，`中断向量`中的`PSW`应标识处于**管态**，这一标识由操作系统初始化程序设置。  

### 特权指令与非特权指令

- 特权指令：

    > - 只有在**管态**才能执行的指令。
    > - 特权指令的执行不仅影响运行程序本身，也影响其他程序和OS[^5]。

- 非特权指令：

    > - 在管态和目态下均可执行的指令。
    >
    > - 只与运行程序本身有关，不影响其它程序和OS。例如数据传送指令、算术运算指令等。

### 地址映射机构[^6]

> 使每个程序的每个基本单位都能<u>从0开始编址</u>，硬件需要提供**地址映射机构**，它负责将运行程序产生的逻辑地址变换为内存物理地址。(不同硬件环境中，地址映射机构有所不同)

### 存储保护设施

> - 为防止在多道程序系统中，一个程序有意或无意产生的错误地址可能会侵犯其它程序空间甚至操作系统空间，硬件必须提供**存储保护设施**。
> - 作用：进行**地址越界检查**和**越权检查**(对共享区域)，防止应用程序侵犯操作系统空间或其它应用程序空间。

### 中断装置

> - 发现并响应中断的硬件机构。
>
> - 功能
>
>     > 1. **发现中断**：中断发生时能识别，有多个中断事件同时发生时，能按优先级别响应最高者。
>     > 2. **响应中断**[^7]：先将当前进程的中断向量(PSW和PC)压入**系统栈**，再根据中断源到<u>指定内存单元</u>将新的中断向量取来并送到**中断向量寄存器**中, 从而转到对应的中断处理程序。

### 通道与DMA控制器

#### 通道

> 负责**I/O操作的处理机**，具有自己的指令系统和运控部件，可以执行通道程序，完成CPU委托的I/O操作任务。

#### DMA (Direct Memory Access, 直接内存访问)

> DMA是与通道相似的I/O方式，DMA控制器接受CPU的委托**完成数据在内存与块型设备之间的传输**。<u>与通道相比，DMA没有独立的指令系统，只能进行简单的块传输</u>。

## 操作系统界面形式

> - 从**虚拟机**的观点看, OS是<u>对计算机硬件的第一级扩充,</u> 配有OS的计算机在功能等方面与**裸机**相比大大地增强了。在大多数情况下, <u>用户通过OS与机器硬件打交道, 而不直接地使用机器硬件</u>。
>
> - 操作系统为用户提供三种界面形式
>
>     > 1. 交互终端命令（或图形用户界面）
>     > 2. 作业控制语言
>     > 3. 系统调用命令

### 交互终端命令（Command Line）

> - 分时系统具有的界面形式。交互终端命令的一般形式为：“命令名,选项,参数”。
>
> - 交互终端命令界面由命令解释程序提供。命令解释程序通常属于**操作系统内核**，但UNIX系统的交互命令解释程序由shell提供，而shell并不属于系统核心，而是运行于核心之外的目态程序，它通过系统调用与核心打交道，完成命令要求的动作。   
>
> - ![https://raw.githubusercontent.com/FANSENG/Figure-bed/master/Picture/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/UNIXShell%E7%95%8C%E9%9D%A2.png](https://raw.githubusercontent.com/FANSENG/Figure-bed/master/Picture/操作系统/UNIXShell界面.png)
>
> - 优点
>
>     > 1. 缩小核心
>     > 2.  不同用户可以选择不同界面

### **图形用户界面**（GUI—Graphic User Interface）

> - 考虑非计算机专业人员使用计算机系统的方便性, 现代操作系统都提供了图形用户界面(GUI), GUI本质上也属于交互式界面，只不过界面由命令行转变为图形提示和鼠标点击。
> - 图形界面一般由视窗、图标、菜单、对话框等基本元素以及对基本元素所能进行的操作构成。有些系统如Windows中，仍保持一个行式命令的界面，不过该界面实际上是作为一个特殊的视窗实现的。

### **作业控制语言**（Job Control Language, JCL）

> - JCL是批处理系统的界面形式。系统为用户提供一种作业控制语言。当欲提交批作业时，用户先用这种语言书写一个作业说明书, 以OS能识别的形式描述用户作业的处理步骤, 再将此说明书与程序、数据一道提交给系统, 操作系统按照作业说明书所规定的步骤一步一步地处理作业。
> - 不同的操作系统具有不同的作业控制语言，作业控制语言一般包含几十个作业控制命令。如，作业标识语句、作业步语句、资源描述语句、Goto语句等。

### **系统调用命令**(System Call)

> - **系统调用命令**也称**应用程序界面(API)**，它是在用户程序级别上与操作系统打交道的方式。操作系统为用户提供一组系统调用命令, 用户可将这些系统调用命令写在程序中, 当用户程序在运行过程中执行到这些系统调用命令时, 将发生自愿性中断, 进入操作系统, 操作系统根据不同的系统调用命令转到相应的处理程序。几乎所有类型的操作系统都有这种界面。 
>
> - 系统调用命令通常可分为如下几类
>
>     > 1. 与文件相关的系统调用命令, 如建立文件、撤消文件、打开文件、关闭文件、读写文件等;
>     > 2. 与进程相关的系统调用命令, 如创建子进程、撤销子进程、跟踪子进程等; 
>     > 3. 与进程通讯相关的系统调用命令, 如发送消息、接收消息、发送信件、接收信件等; 
>     > 4. 与资源相关的系统调用命令, 如申请资源、释放资源等。

## **操作系统的运行机理**

> - 操作系统是**中断驱动**的，考虑系统中并发执行的两个程序P1和P2，假若时刻t1程序P1执行，时刻t2程序P2执行，t1<t2, 则在时刻(t1,t2)之间一定发生过中断，即**中断是程序切换的必要条件**。 
> - ![https://raw.githubusercontent.com/FANSENG/Figure-bed/master/Picture/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%A4%9A%E9%81%93%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C%E6%9C%BA%E7%90%86.png](https://raw.githubusercontent.com/FANSENG/Figure-bed/master/Picture/操作系统/多道程序运行机理.png)
> - 引起中断的事件有些与运行程序有关，如访管、地址越界、非法指令、溢出等；有些与运行进程无关，如系统时钟、I/O设备完成信号等。

---

[^1]:计算机提供的资源: CPU、内存、设备、文件（本质是信息，指的是数据和程序，以文件形式存在
[^2]:GUI:Graphic User Interface
[^3]:时间值保存于硬件寄存器中，开机时由电源供电计时，关机时由机内电池供电计时，其值可由程序设定和修改，但一般通过特权指令完成。 操作系统根据绝对时钟的值记录作业进入系统时间和处理时间、文件的修改和存取时间、资源占用时间、日志记录时间等。
[^4]:每个运行程序都有一个对应的系统栈，进程切换的同时伴随系统栈的切换，但硬件只有一个系统栈指针作用。
[^5]:如，开关中断、**置程序状态字**、修改地址映射寄存器、停机等。一般只有OS能执行特权指令，<u>用户程序不能执行</u>。
[^6]:保证每个程序的每个基本单位逻辑上从0开始编址，负责物理地址和逻辑地址的转换。
[^7]:当前进程中断向量压入系统栈，中断源的中断向量放入中断向量寄存器